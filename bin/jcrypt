#!/usr/bin/env node

(() => {
    'use strict';

    let jcrypt = require('../lib/util'),
        Getopt = require('node-getopt'),
        callback = (type, err, data) => {
            console.log(!err ?
                ('Created ' + type + ' file ' + data) :
                '[ERROR] No such file'
            );
        },
        getopt, opt, filename;

    function doOperation(type, args) {
        // '--decrypt' or '--encrypt'
        let op = `--${type}`;

        args = args || [];

        if (!opt.stream) {
            jcrypt(filename, opt.output, [op].concat(args))
                .then(console.log)
                .catch((err) => {
                    console.log(err);
                    process.exit();
                });
        } else {
            jcrypt.stream(filename, opt.output, [op].concat(args))
                .then(console.log)
                .catch((err) => {
                    console.log(err);
                    process.exit();
                });
        }
    }

    getopt = new Getopt([
        ['a', 'armor', 'Output the enciphered data as ASCII.'],
        ['d', 'decrypt=arg', 'Perform decryption.'],
        ['e', 'encrypt=arg', 'Perform encryption.'],
        ['o', 'output=arg', 'The output file.  Will prompt for it if not given.'],
        ['r', 'recipients=arg', 'The intended person(s).'],
        ['s', 'sign', 'Digitally sign as well as encipher.'],
        ['', 'stream', 'Use streams.'],
        ['h', 'help', 'Display help.']
    ]).bindHelp();

    // `parseSystem` is an alias of parse(process.argv.slice(2)).
    opt = getopt.parseSystem().options;

    if ((filename = opt.decrypt) !== undefined) {
        doOperation('decrypt');
    } else if ((filename = opt.encrypt) !== undefined) {
        let args = [];

        /*
        if (opt.armor) {
            args.push('--armor');
        }
        */

        // For now, default to always armor.
        args.push('--armor');

        if (opt.recipients) {
            args.push('-r', opt.recipients);
        } else {
            // Have it default to me for now.
            args.push('-r', 'benjam72@yahoo.com');
        }

        if (opt.sign) {
            args.push('--sign');
        }

        doOperation('encrypt', args);
    }
}());

