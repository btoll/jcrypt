#!/usr/bin/env node

(function () {
    'use strict';

    let jcrypt = require('../lib/util.js'),
        Getopt = require('node-getopt'),
        callback = function (type, err, data) {
            console.log(!err ?
                ('Created ' + type + ' file ' + data) :
                '[ERROR] No such file'
            );
        },
        args = [],
        getopt, opt, filename;

    getopt = new Getopt([
        ['a', 'armor', 'Output the enciphered data as ASCII.'],
        ['d', 'decrypt=ARG', 'Perform decryption.'],
        ['e', 'encrypt=ARG', 'Perform encryption.'],
        ['o', 'output=ARG', 'The output file.  Will prompt for it if not given.'],
        ['r', 'recipients=ARG', 'The intended person(s).'],
        ['s', 'sign', 'Digitally sign as well as encipher.'],
        ['h', 'help', 'Display help.']
    ]).bindHelp();

    // `parseSystem` is an alias of parse(process.argv.slice(2)).
    opt = getopt.parseSystem().options;

    if ((filename = opt.decrypt) !== undefined) {
        jcrypt.stream(filename, opt.output, ['--decrypt'])
            .then(console.log)
            .catch(function (err) {
                console.log(err);
                process.exit();
            });
    } else if ((filename = opt.encrypt) !== undefined) {
        if (opt.armor) {
            args.push('--armor');
        }

        if (opt.recipients) {
            args.push('-r', opt.recipients);
        } else {
            // Have it default to me for now.
            args.push('-r', 'benjam72@yahoo.com');
        }

        if (opt.sign) {
            args.push('--sign');
        }

        jcrypt.stream(filename, opt.output, ['--encrypt'].concat(args))
            .then(console.log)
            .catch(function (err) {
                console.log(err);
                process.exit();
            });
    }
}());

